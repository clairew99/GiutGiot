# ë°°í¬ ê°€ì´ë“œ

# ğŸ” Stacks

### Management Tool

`Jira` `Mattermost` `Discord` `Notion` `GitLab` `Figma` `ERDCloud`

### IDE

`VSCode` `Intellij` `Android Studio`

### Infra

`EC2` `Docker(27.1.1)` `Ubuntu(20.04.6)` `Jenkins(2.469)`

### Frontend

`Flutter(3.22.3)` 

### Backend

`Java(17)` `Spring boot(3.3.2)` `Spring Date JPA(3.2.3)` `jjwt(0.11.5)` `Mysql(9.0.1)` `Redis(7.4.0)`

### AI

`Python(3.9)` `Flask(3.0.3)`
- Flask > requirements.txt ì°¸ê³ ê³ 

# ğŸ—ƒï¸ Build & Distribute

## Backend Build
-${}ë¡œ í‘œì‹œëœ ë³€ìˆ˜ëŠ” ì¶”í›„ EC2ì— ìƒì„±í•œ .envì—ì„œ ì»¨í…Œì´ë„ˆ ìƒì„± ì‹œ í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •

### application.yaml
- ìœ„ì¹˜ : kiot > src > main > resources

```
spring:
  application:
    name: kiot

  profiles:
    active: ${PROFILE}

  mvc:
    pathmatch:
      matching-strategy: ant_path_matcher

  jpa:
    properties:
      hibernate:
        default_batch_fetch_size: 100

  web:
    resources:
      add-mappings: false

  data:
    redis:
      host: 43.203.122.185
      port: 6379


```

### application-dev.yaml
- PROFILEì´ devì¼ë•Œ ì‹¤í–‰ë˜ëŠ” íŒŒì¼
- ìœ„ì¹˜ : kiot > src > main > resources
```
spring:
  config:
    activate:
      on-profile: dev

  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: ${DB_URL}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}

  jpa:
    hibernate:
      ddl-auto: create-drop
    properties:
      hibernate:
        format_sql: false
        dialect: org.hibernate.dialect.MySQL8Dialect
    defer-datasource-initialization: true

  sql:
    init:
      mode: always
      data-locations: classpath:sql/data-dev.sql

  security:
    oauth2:
      client:
        registration:
          google:
            client-id: ${GOOGLE_CLIENT_ID}
            client-secret: ${GOOGLE_CLIENT_SECRET}
            redirect-uri: ${GOOGLE_REDIRECT_URI}
            scope: profile, email
          naver:
            client-id: ${NAVER_CLIENT_ID}
            client-secret: ${NAVER_CLIENT_SECRET}
            redirect-uri: ${NAVER_REDIRECT_URI}
            authorization-grant-type: authorization_code
            scope: email, nickname
          kakao:
            client-id: ${KAKAO_CLIENT_ID}
            client-secret: ${KAKAO_CLIENT_SECRET}
            redirect-uri: ${KAKAO_REDIRECT_URI}
            client-authentication-method: client_secret_post
            authorization-grant-type: authorization_code
            scope: account_email, profile_nickname
            client-name: kakao
        provider:
          google:
            authorization-uri: https://accounts.google.com/o/oauth2/auth
            token-uri: https://oauth2.googleapis.com/token
            user-info-uri: https://www.googleapis.com/oauth2/v3/userinfo
            user-name-attribute: sub
          naver:
            authorization-uri: https://nid.naver.com/oauth2.0/authorize
            token-uri: https://nid.naver.com/oauth2.0/token
            user-info-uri: https://openapi.naver.com/v1/nid/me
            user-name-attribute: response
          kakao:
            authorization-uri: https://kauth.kakao.com/oauth/authorize
            token-uri: https://kauth.kakao.com/oauth/token
            user-info-uri: https://kapi.kakao.com/v2/user/me
            user-name-attribute: id

server:
  port: 8443
  ssl:
    key-store: ${KEY_STORE_PATH}
    key-store-password: ${KEY_STORE_PASSWORD}
    key-store-type: PKCS12
    key-alias: ${KEY_ALIAS}
  http-port: 8080


jwt:
  secret: ${JWT_SECRET}
  access_expiration: ${JWT_ACCESS_EXPIRATION}
  refresh_expiration: ${JWT_REFRESH_EXPIRATION}
```

### IDE ë° í™˜ê²½ì„¤ì •

```
1. jdk 17 ë‹¤ìš´ë¡œë“œ ë° í™˜ê²½ë³€ìˆ˜ ì„¤ì •
2. git clone í›„ backend í´ë”ë¥¼ Intellijì—ì„œ Opení•˜ì—¬ ê°€ì ¸ì˜¤ê¸°
3. Intellij - File - Project Structure - Projectì—ì„œ SDKë¥¼ 17ë²„ì „ìœ¼ë¡œ ë§ì¶”ê¸°
4. Intellij - File - Settings - Gradleì—ì„œ Gradle JVMì„ [1]ì—ì„œ ì¶”ê°€í•œ í™˜ê²½ë³€ìˆ˜ë¡œ ì§€ì •
5. Intellij ìš°ì¸¡ Gradle í´ë¦­ í›„ ìƒˆë¡œê³ ì¹¨
6. Intellij - Run - KiotApplicationìœ¼ë¡œ ì‹¤í–‰
```

### Dockerfile (Back)
- ìœ„ì¹˜ : kiot

```docker
# base ì´ë¯¸ì§€ ì„¤ì •
FROM openjdk:17

# Docker ì»¨í…Œì´ë„ˆ ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# JAR_FILE ë³€ìˆ˜ ì •ì˜
ARG JAR_FILE=build/libs/*.jar

# ì´ë¯¸ì§€ ì‹¤í–‰ ì‹œ í•­ìƒ ì‹¤í–‰ë˜ì–´ì•¼ í•˜ëŠ” ì»¤ë§¨íŠ¸ ì„¤ì •
# í˜¸ìŠ¤íŠ¸ ì‹œìŠ¤í…œì˜ build/libs ë””ë ‰í† ë¦¬ì— ìˆëŠ” ëª¨ë“  jar íŒŒì¼ì„
# Docker ì»¨í…Œì´ë„ˆì˜ /app ë””ë ‰í† ë¦¬ì— application.jar ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë³µì‚¬
COPY ${JAR_FILE} springServer.jar

# ì»¨í…Œì´ë„ˆê°€ ë¦¬ìŠ¤ë‹í•  í¬íŠ¸ ë° í”„ë¡œí† ì½œ ì„¤ì •
# ì§€ì •ëœ í¬íŠ¸ëŠ” í•´ë‹¹ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œë§Œ ìœ íš¨
EXPOSE 8080

# ì´ë¯¸ì§€ ì‹¤í–‰ì‹œ ë””í´íŠ¸ ì»¤ë§¨ë“œ
# ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹œ java -jar application.jar ëª…ë ¹ ì‹¤í–‰í•´ ìë°” ì–´í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
CMD ["java", "-jar", "springServer.jar"]

```

---

## Frontend Build

### apk íŒŒì¼ë¡œ ë¹Œë“œ
```
flutter build apk --release --target-platform=android-arm64
```
í„°ë¯¸ë„ì— ì…ë ¥ í›„, ë‚˜ì˜¤ëŠ” ê²½ë¡œì—ì„œ release apk ë¡œ ê³µìœ 

## ë°°í¬ íŒŒì¼ í´ë” êµ¬ì¡°

```
ğŸ“¦githerbs
 â”£ ğŸ“‚domain
 â”ƒ â”£ ğŸ“‚auth
 â”ƒ â”ƒ â”£ ğŸ“‚controller
 â”ƒ â”ƒ â”£ ğŸ“‚dto
 â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚common
 â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚request
 â”ƒ â”ƒ â”ƒ â”— ğŸ“‚response
 â”ƒ â”ƒ â”£ ğŸ“‚entity
 â”ƒ â”ƒ â”£ ğŸ“‚repository
 â”ƒ â”ƒ â”— ğŸ“‚service
 â”ƒ â”£ ğŸ“‚board
 â”ƒ â”ƒ â”£ ğŸ“‚controller
 â”ƒ â”ƒ â”£ ğŸ“‚dto
 â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚request
 â”ƒ â”ƒ â”ƒ â”— ğŸ“‚response
 â”ƒ â”ƒ â”£ ğŸ“‚entity
 â”ƒ â”ƒ â”£ ğŸ“‚repository
 â”ƒ â”ƒ â”— ğŸ“‚service
 â”ƒ â”£ ğŸ“‚event
 â”ƒ â”ƒ â”£ ğŸ“‚controller
 â”ƒ â”ƒ â”£ ğŸ“‚dto
 â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚request
 â”ƒ â”ƒ â”ƒ â”— ğŸ“‚response
 â”ƒ â”ƒ â”£ ğŸ“‚entity
 â”ƒ â”ƒ â”£ ğŸ“‚repository
 â”ƒ â”ƒ â”— ğŸ“‚service
 â”ƒ â”£ ğŸ“‚herb
 â”ƒ â”ƒ â”£ ğŸ“‚controller
 â”ƒ â”ƒ â”£ ğŸ“‚dto
 â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚request
 â”ƒ â”ƒ â”ƒ â”— ğŸ“‚response
 â”ƒ â”ƒ â”£ ğŸ“‚entity
 â”ƒ â”ƒ â”£ ğŸ“‚repository
 â”ƒ â”ƒ â”— ğŸ“‚service
 â”ƒ â”£ ğŸ“‚manual
 â”ƒ â”ƒ â”£ ğŸ“‚controller
 â”ƒ â”ƒ â”£ ğŸ“‚dto
 â”ƒ â”ƒ â”ƒ â”— ğŸ“‚response
 â”ƒ â”ƒ â”£ ğŸ“‚entity
 â”ƒ â”ƒ â”£ ğŸ“‚repository
 â”ƒ â”ƒ â”— ğŸ“‚service
 â”ƒ â”£ ğŸ“‚member
 â”ƒ â”ƒ â”£ ğŸ“‚controller
 â”ƒ â”ƒ â”£ ğŸ“‚dto
 â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚common
 â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚request
 â”ƒ â”ƒ â”ƒ â”— ğŸ“‚response
 â”ƒ â”ƒ â”£ ğŸ“‚entity
 â”ƒ â”ƒ â”£ ğŸ“‚repository
 â”ƒ â”ƒ â”— ğŸ“‚service
 â”ƒ â”— ğŸ“‚search
 â”ƒ â”ƒ â”£ ğŸ“‚controller
 â”ƒ â”ƒ â”£ ğŸ“‚dto
 â”ƒ â”ƒ â”ƒ â”— ğŸ“‚response
 â”ƒ â”ƒ â”£ ğŸ“‚entity
 â”ƒ â”ƒ â”£ ğŸ“‚repository
 â”ƒ â”ƒ â”— ğŸ“‚service
 â”£ ğŸ“‚global
 â”ƒ â”£ ğŸ“‚common
 â”ƒ â”ƒ â”£ ğŸ“‚code
 â”ƒ â”ƒ â”£ ğŸ“‚exception
 â”ƒ â”ƒ â”— ğŸ“‚response
 â”ƒ â”£ ğŸ“‚config
 â”ƒ â”— ğŸ“‚handler
 â”— ğŸ“œGitherbsApplication.java

```

```
ğŸ“¦frontend
 â”£ ğŸ“‚public
 â”ƒ â”£ ğŸ“‚grass
 â”ƒ â”£ ğŸ“‚herbs
 â”ƒ â”£ ğŸ“‚pediaimg
 â”ƒ â”£ ğŸ“‚profileimg
 â”£ ğŸ“‚src
 â”ƒ â”£ ğŸ“‚apis
 â”ƒ â”£ ğŸ“‚assets
 â”ƒ â”ƒ â”£ ğŸ“‚fonts
 â”ƒ â”£ ğŸ“‚components
 â”ƒ â”ƒ â”£ ğŸ“‚board
 â”ƒ â”ƒ â”£ ğŸ“‚escape
 â”ƒ â”ƒ â”£ ğŸ“‚herbdetail
 â”ƒ â”ƒ â”£ ğŸ“‚main
 â”ƒ â”ƒ â”£ ğŸ“‚mypage
 â”ƒ â”ƒ â”£ ğŸ“‚pedia
 â”ƒ â”ƒ â”£ ğŸ“‚picture
 â”ƒ â”ƒ â”£ ğŸ“‚search
 â”ƒ â”£ ğŸ“‚pages
 â”ƒ â”£ ğŸ“‚store
 â”ƒ â”£ ğŸ“‚utils

```

```
ğŸ“¦data
 â”£ ğŸ“‚image
 â”ƒ â”£ ğŸ“‚model
 â”ƒ â”£ ğŸ“‚notebook
 â”ƒ â”ƒ â”£ ğŸ“‚output
 â”£ ğŸ“‚search
```

# âš™ï¸ Server Settings

## Putty

- PuttyGen ì´ìš©í•´ .pem -> .ppk ë¡œ ë°”ê¾¸ê¸°

- Putty í†µí•´ EC2 ì„œë²„ì— ì ‘ì†
```
1. Category > Connection > SSH > Auth > Credentials í´ë¦­
2. Public-Key authentication
	- Browse ë¡œ ppk íŒŒì¼ ì„ íƒ
3. Category > Session > Host name (or IP address) ì— ì œê³µë°›ì€ ì£¼ì†Œ ì…ë ¥
4. Port: 22, Connection Type: SSH
5. Open
```

## Server Default Setting

- í•œêµ­ í‘œì¤€ì‹œë¡œ ë³€ê²½

```bash
sudo timedatectl set-timezone Asia/Seoul
```

- íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸ ë° íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸

```bash
sudo apt-get -y update && sudo apt-get -y upgrade
```

## Docker Setting

- Docker ì„¤ì¹˜ ì „ í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
sudo apt-get -y install apt-transport-https ca-certificates curl gnupg-agent software-properties-common
```

- amd / arm í™•ì¸

```bash
dpkg -s libc6 | grep Arch
```

- ìœ„ì— í•´ë‹¹í•˜ëŠ” ê³„ì—´ë¡œ Docker ë ˆí¬ì§€í† ë¦¬ ë“±ë¡
ì„ì˜ë¡œ amd / arm â‡’ verë¡œ ì‘ì„±

```bash
sudo add-apt-repository "deb [arch=ver64] https://download.docker.com/linux/ubuntu$(lsb_release -cs) stable"
```

- íŒ¨í‚¤ì§€ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 

```bash
sudo apt-get -y update
```

- Docker íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
sudo apt-get -y install docker-ce docker-ce-cli containerd.io
```

- Docker ì„œë¹„ìŠ¤ ì¬ì‹œì‘

```bash
sudo service docker restart
exit
```

## SSL Setting
```
keytool -genkeypair -alias key_dev -keyalg RSA -keysize 2048 -storetype PKCS12 -keystore keystore_dev.p12 -validity 365
```
ëª…ë ¹ì–´ ì…ë ¥í•´ keystore_dev.p12 ìƒì„±


## Mysql

- ì‚¬ìš©í•˜ë ¤ëŠ” port ë²ˆí˜¸ ì—´ê¸°
```
sudo ufw allow 3306
```

- Docker mysql ì´ë¯¸ì§€ ë°›ê¸°
```
docker pull mysql:latest
```

- ë°›ì€ ì´ë¯¸ì§€ë¡œ mysql ì‹¤í–‰
```
docker run -d --name mysql(ì»¨í…Œì´ë„ˆëª…) -e MYSQL_ROOT_PASSWORD=ë£¨íŠ¸ íŒ¨ìŠ¤ì›Œë“œ -p 3306:3306 mysql:latest
```
- Workbenchì— ì—°ê²°
```
1. MySQL Connections > + > Setup New Connection
2. Hostname: ë„ë©”ì¸, Port: EC2 MySQL í¬íŠ¸
3. Test Connection í´ë¦­
4. ë£¨íŠ¸ íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥
5. Continue Anyway
```


- Database ìƒì„±
```
create database {DBëª…}
```


## Redis

- ì‚¬ìš©í•˜ë ¤ëŠ” port ë²ˆí˜¸ ì—´ê¸°
```
sudo ufw allow 6379
```

- Docker redis ì´ë¯¸ì§€ ë°›ê¸°
```
docker pull mysql:latest
```

- ë°›ì€ ì´ë¯¸ì§€ë¡œ redis ì‹¤í–‰
```
docker run -d --name redis(ì»¨í…Œì´ë„ˆëª…) -p 6379:6379 redis
```

## Jenkins

- docker-compose.yml ì‘ì„±

```
version: '3'

services:
  jenkins:
    image: jenkins/jenkins:latest-jdk17
    privileged: true
    user: root
    ports:
      - í¬íŠ¸ë²ˆí˜¸!!!:8080
    container_name: ì»¨í…Œì´ë„ˆì´ë¦„!!!!
    volumes:
      - ./jenkins_home:/var/jenkins_home
    restart: unless-stopped
    command: bash -c "apt-get update && apt-get install -y docker.io && jenkins.sh"
```

- docker-compose up -d ì‹¤í–‰ í›„

```
docker logs ì»¨í…Œì´ë„ˆì´ë¦„!!! ì‹¤í–‰ ê·¸ ì•ˆì—ì„œ í† í°ì´ ë“±ì¥
ì§€ì •ëœ í¬íŠ¸ë¡œ ì ‘ì† í›„ í† í°ì„ ì…ë ¥ í•˜ë©´ ê¸°ë³¸ ì„¤ì • í˜ì´ì§€ê°€ ë“±ì¥
idì™€ password ì„¤ì • í›„ ê¸°ë³¸ í”ŒëŸ¬ê·¸ì¸ ë‹¤ìš´ë¡œë“œ ì§„í–‰
```

- ì¶”ê°€ í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜

```
SSH Agent

Docker
Docker Commons
Docker Pipeline
Docker API

Generic Webhook Trigger

GitLab
GitLab API,
GitLab Authentication
```

- ìƒˆë¡œìš´ pipeline ìƒì„±

```
1. ìƒì„± í›„ Build Triggersì•ˆì— Build when a change is pushed to GitLab. GitLab webhook URL: ì²´í¬ í›„ URL ë³µì‚¬
2. push Eventsì™€ Opened Merge Request Events ì²´í¬
3. ê³ ê¸‰ì„ ì„ íƒ í›„ Secret token Generate ì‹¤í–‰ í›„ ë³µì‚¬
4. ê¹ƒë© ì ‘ì† í›„ í”„ë¡œì íŠ¸ ì„ íƒ â†’ Settings â†’ Webhooks ì ‘ì†
5. add new webhook ì„ íƒ í›„ jenkinsì—ì„œ ë³µì‚¬í•œ URL ì…ë ¥
6. Secret tokenì— ë³µì‚¬í–ˆë˜ Secret token ì…ë ¥
7. íŠ¸ë¦¬ê±°ì— push events ì„ íƒ ë° ë¸Œëœì¹˜ ì§€ì • í›„ ì €ì¥
```

## Docker Hub Setting

- Docker Hub Token ë°œê¸‰

```
1. ìš°ì¸¡ ìƒë‹¨ì˜ Sign in ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¡œê·¸ì¸ (ì†Œì…œë¡œê·¸ì¸ ê¶Œì¥í•˜ì§€ ì•ŠìŒ)
2. ìš°ì¸¡ ìƒë‹¨ì˜ ê³„ì •ëª…ì„ í´ë¦­í•˜ì—¬ Account Settings í´ë¦­
3. New Access Token - Read,Write,Delete ê¶Œí•œì„ ê°€ì§„ Token ë°œê¸‰
4. Token ê°’ ì €ì¥
```

- Docker Hub Repository ìƒì„±

```
1. ìƒë‹¨ì˜ Repositories - Create repository í´ë¦­
2. Visibility ì§€ì • í›„ Create í´ë¦­
```

## Jenkins Pipeline Setting

- í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜
    - Jenkins ê´€ë¦¬ - Plugins - Available Plugins - ì„ íƒ í›„ Install without restart í´ë¦­

```
SSH Agent

Docker
Docker Commons
Docker Pipeline
Docker API

Generic Webhook Trigger

GitLab
GitLab API,
GitLab Authentication
```

- Docker Hub Credential ë“±ë¡
    - Jenkins ê´€ë¦¬ - Credentials - global - Add Credentials - Create

```
Kind: Username with password
Username: Docker Hubì—ì„œ ì‚¬ìš©í•˜ëŠ” ID
Password: Docker Hubì—ì„œ ì‚¬ìš©í•˜ëŠ” Token ê°’
ID: Credentialì— ëŒ€í•œ ë³„ì¹­
```

- GitLab Credential ë“±ë¡
    - Jenkins ê´€ë¦¬ - Credentials - global - Add Credentials - Create

```
Kind: Username with password
Username: GitLab ê³„ì • ì•„ì´ë”” ì…ë ¥
Password: GitLab ê³„ì • ë¹„ë°€ë²ˆí˜¸
ID: Credentialì— ëŒ€í•œ ë³„ì¹­
```

- Ubuntu Credential ë“±ë¡
    - Jenkins ê´€ë¦¬ - Plugins - Available Plugins - SSH Agent
    - Jenkins ê´€ë¦¬ - Credentials - global - Add Credentials - Create

```
Kind: Username with private key
ID: Credentialì— ëŒ€í•œ ë³„ì¹­
Username: SSH ì›ê²© ì„œë²„ í˜¸ìŠ¤íŠ¸ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê³„ì •ëª…(ubuntu)
====> Enter directly - Add í´ë¦­
.pem í‚¤ì˜ ë‚´ìš©ì„ ë©”ëª¨ì¥ì„ ì½ì–´ ë³µì‚¬ í›„ Keyì— ë¶™ì—¬ë„£ì€ í›„ Create
```

- Gradle ì¶”ê°€
    - Jenkins ê´€ë¦¬ - Tools

```
name: gradle
Install automatically ì²´í¬
í”„ë¡œì íŠ¸ ë²„ì „ì— ë§ëŠ” Gradle ì„ íƒ í›„ Save
```

# ğŸ¬ Deployment Command

- Spring Boot í¬íŠ¸ ì—´ê¸°
```
sudo ufw allow 8443
```

- Spring Boot ì»¨í…Œì´ë„ˆì— ì„¤ì •ë˜ì–´ì•¼ í•˜ëŠ” í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
```
vi .env
```
 - .env
```
TZ=Asia/Seoul
DB_URL=jdbc:mysql://{ë„ë©”ì¸}/{ìƒì„±í•œ Databaseëª…}
DB_USERNAME=root
DB_PASSWORD={rootë¹„ë°€ë²ˆí˜¸}
PROFILE=dev
JWT_SECRET={ì‹œí¬ë¦¿í‚¤}
JWT_ACCESS_EXPIRATION=31536000
JWT_REFRESH_EXPIRATION=604800
KIOT_URL=https://{ë„ë©”ì¸ëª…}:8443
GOOGLE_CLIENT_ID=378466713378-9u8gluhjc8vm9v8j3oa84u3p66tnp27p.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=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
GOOGLE_REDIRECT_URI=https://i11a409.p.ssafy.io:8443/login/oauth2/code/google
NAVER_CLIENT_ID=TEPjVofOM4P6q381iWaE
NAVER_CLIENT_SECRET=KL9NfkRmrG
NAVER_REDIRECT_URI=https://i11a409.p.ssafy.io:8443/login/oauth2/code/naver
KAKAO_CLIENT_ID=b1f4c6953f1e8f167dcf24be7f74e3c1
KAKAO_CLIENT_SECRET=UThPLJJiPYtE3RgH4ymclvZqdfzL3uzh
KAKAO_REDIRECT_URI=https://i11a409.p.ssafy.io:8443/login/oauth2/code/kakao
KEY_STORE_PATH=/app/keystore_dev.p12
KEY_STORE_PASSWORD=ssafyssafy
KEY_ALIAS=key_dev
IP_ADDRESS=172.26.10.56
```


## Pipeline (Back)

```bash
pipeline {
    agent any
    
    environment {
        imagename = "dockerhub repo ì´ë¦„" // ì‚¬ìš©ìëª…/repoëª…
        registryCredential = 'dockerhub' // docker hub credential ID
        dockerImage = ''
        releaseServerAccount = 'ubuntu'
        releaseServerUri = 'ì œê³µë°›ì€ ë„ë©”ì¸'
        // releasePort = '8080' // Spring bootëŠ” 8080 í¬íŠ¸
    }
    
    tools {
        gradle 'gradle'
    }
    
    stages {
        stage('clone') {
            steps {
                git branch: 'ë¸Œëœì¹˜ëª…', credentialsId: 'GitlabCredentialID', url: 'https~.git í˜•ì‹ì˜ Git ì£¼ì†Œ'
            }
        }
        stage('back_build') {
            steps {
                dir('kiot') { // í•˜ìœ„ì˜ 'kiot' ë””ë ‰í† ë¦¬ë¡œ ì´ë™
                    sh "chmod +x gradlew"
                    sh "./gradlew clean bootJar"
                }
            }
        }
        stage('docker-build'){
            steps {
                dir('kiot'){
                    script {
                        docker.withRegistry('', registryCredential) {
                        sh "docker buildx create --use --name mybuilder"
                        sh "docker buildx build --platform linux/amd64,linux/arm64 -t $imagename:$BUILD_NUMBER --push ."
                        sh "docker buildx build --platform linux/amd64,linux/arm64 -t $imagename:latest --push ."
                    }
                    }
                }
            }
        }
        
        stage('Before Service Stop') {
            steps {
                sshagent(credentials: ['UbuntuCredentialID']) {
                    sh '''
                    if test "`ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker ps -aq --filter ancestor=$imagename:latest"`"; then
                    ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker stop $(docker ps -aq --filter ancestor=$imagename:latest)"
                    ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker rm -f $(docker ps -aq --filter ancestor=$imagename:latest)"
                    ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker rmi $imagename:latest"
                    fi
                    '''
                }
            }
        }
        stage('SSH-Server-EC2'){
            steps {
                echo 'SSH'
                
                sshagent(credentials: ['UbuntuCredentialID']) {
                    
                    sh 'ssh -o StrictHostKeyChecking=no ubuntu@ë„ë©”ì¸ "docker pull ì‚¬ìš©ìëª…/repoëª…:latest"'
                    sh 'ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "sudo docker run -d -i -v ~/keystore_dev.p12:/app/keystore_dev.p12 --env-file ~/.env --name kiotserver -p 8443:8443 $imagename:latest"'
                } 
            }
        }
    }
}
```

- Flask í¬íŠ¸ ì—´ê¸°
```
sudo ufw allow 5000
```

## Pipeline (Flask)

```bash
pipeline {
    agent any
    
    environment {
        imagename = "dockerhub repo ì´ë¦„" // ex: ì‚¬ìš©ìëª…/repoëª…
        registryCredential = 'dockerhub' // docker hub credential ID
        dockerImage = ''
        releaseServerAccount = 'ubuntu'
        releaseServerUri = 'ì œê³µë°›ì€ ë„ë©”ì¸'
        // releasePort = '5000' // Flaskì˜ í¬íŠ¸ëŠ” 5000
    }
    
    stages {
        stage('clone') {
            steps {
                git branch: 'ë¸Œëœì¹˜ëª…', credentialsId: 'credentialëª…', url: 'https~.git í˜•ì‹ì˜ Git ì£¼ì†Œ'
            }
        }
        
        stage('docker-build'){
            steps {
                dir('Flask'){ // flask ë¸Œëœì¹˜ > Flask í´ë”ë¡œ ì§„ì…
                    script {
                        docker.withRegistry('', registryCredential) {
                        sh "docker buildx create --use --name mybuilder"
                        sh "docker buildx build --platform linux/amd64,linux/arm64 -t $imagename:$BUILD_NUMBER --push ."
                        sh "docker buildx build --platform linux/amd64,linux/arm64 -t $imagename:latest --push ."
                    }
                    }
                }
            }
        }
        stage('Before Service Stop') {
            steps {
                sshagent(credentials: ['UbuntuCredentialID']) {
                    sh '''
                    if test "`ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker ps -aq --filter ancestor=$imagename:latest"`"; then
                    ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker stop $(docker ps -aq --filter ancestor=$imagename:latest)"
                    ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker rm -f $(docker ps -aq --filter ancestor=$imagename:latest)"
                    ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker rmi $imagename:latest"
                    fi
                    '''
                }
            }
        }
        stage('SSH-Server-EC2'){
            steps {
                echo 'SSH'
                
                sshagent(credentials: ['UbuntuCredentialID']) {
                    
                    sh 'ssh -o StrictHostKeyChecking=no ubuntu@ë„ë©”ì¸ "docker pull ì‚¬ìš©ìëª…/repoëª…:latest"'
                    sh 'ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "sudo docker run -d -i -e TZ=Asia/Seoul -e PYANNOTE_TOKEN=í† í°ê°’ -e SECRET_KEY=ì‹œí¬ë¦¿í‚¤ ê°’ --name ì»¨í…Œì´ë„ˆëª… -p EC2í¬íŠ¸ë²ˆí˜¸:ì»¨í…Œì´ë„ˆí¬íŠ¸ $imagename:latest"'
                    
                } 
            }
        }
    }
}
```
