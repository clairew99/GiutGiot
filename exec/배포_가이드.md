# ë°°í¬ ê°€ì´ë“œ

# ğŸ” Stacks

### Management Tool

`Jira` `Mattermost` `Discord` `Notion` `GitLab` `Figma` `ERDCloud`

### IDE

`VSCode` `Intellij` `Android Studio`

### Infra

`EC2` `Docker(25.0.4)` `Ubuntu(20.04.6)` `Jenkins(2.469)`

### Frontend

`HTML5` `CSS` `JS` `React(18.2.0)` `Axios(1.6.8)` `React-Router-Dom(6.22.3)` `Node(20.11.1)` `React-Dom(18.2.0)` `Zustand(4.5.2)` `Styled-Components(6.1.8)` 

### Backend

`Java(17)` `Spring boot(3.2.3)` `Spring Date JPA(3.2.3)` `jjwt(0.12.5)` `QueryDsl(5.0.0)` `Mysql(8.0)` `Redis(7.2.4)` `Elasticsearch(8.12.2)`

### AI

`Python(3.11)` `FastAPI(0.110.0)` `uvicorn(0.29.0)` `tensorflow(2.15.0)` `konply(0.6.0)` `pandas(2.2.1)` `numpy(1.26.4)` `scikit-learn(1.12.0)` `jupyter hub(4.0.2)`

# ğŸ—ƒï¸ Build & Distribute

## Backend Build

### application.yml

```
spring:
  datasource:
    driver-class-name: {DB Driver}
    url: {DB URL}
    username: {DB username}
    password: {DB password}
    hikari:
      maximum-pool-size: {Pool SIze}
  jpa:
    hibernate:
      ddl-auto: update
    defer-datasource-initialization: true
  sql:
    init:
      mode: always
  servlet:
    multipart:
      max-file-size: {ì—…ë¡œë“œ ìš©ëŸ‰ ì œí•œ}
      max-request-size: {ì—…ë¡œë“œ ìš©ëŸ‰ ì œí•œ}
  jackson:
    time-zone: {íƒ€ì„ì¡´ ì„¸íŒ…}

  jwt:
    header: {JWT hearder ì„¸íŒ…}
    secret: {JWT Secret ì„¸íŒ…}
    access-token-validity-in-seconds: {access token ìœ íš¨ê¸°ê°„ ì„¤ì •}
    refresh-token-validity-in-seconds: {refresh token ìœ íš¨ê¸°ê°„ ì„¤ì •}
  elasticsearch:
    uris: {Elascitsearech URL}
    password: {Elasticsearch password}
    username: {Elasticsearch username}

redis:
  master:
    host: {Redis URL}
    port: {Redis port}
  password: {Redis password}

server:
  port: {Server port}
  servlet:
    context-path: {Server context path}

management:
  endpoints:
    enabled-by-default: false
  endpoint:
    health:
      enabled: true

kakao:
  api:
    secret: {kakao REST api key}
  login:
    secret: {kakao REST api key}
    redirect: {kakao login redirect URL}
    tmp-path: {kakao login tmp-path}
swagger:
  local: {swagger local URL}
  production: {swagger production URL}

feign :
  fast-api:
    url: {fast-api URL}
  kakao:
    token: {kakao token URL}
    authorize: {kakao authorize URL}
    user: {kakao user URL}

cloud:
  aws:
    s3:
      bucket: {bucket name}
    credentials:
      access-key: {aws s3 credentials access-key}
      secret-key: {aws s3 credentials secret-key}
    region:
      static: {aws s3 region}
      auto: false
    stack:
      auto: false
    prefix: {aws s3 bucket URL}

default:
  profile:
    image:
      url: {default profile image url}

```

### IDE ë° í™˜ê²½ì„¤ì •

```
1. jdk 17 ë‹¤ìš´ë¡œë“œ ë° í™˜ê²½ë³€ìˆ˜ ì„¤ì •
2. git clone í›„ backend í´ë”ë¥¼ Intellijì—ì„œ Opení•˜ì—¬ ê°€ì ¸ì˜¤ê¸°
3. Intellij - File - Project Structure - Projectì—ì„œ SDKë¥¼ 17ë²„ì „ìœ¼ë¡œ ë§ì¶”ê¸°
4. Intellij - File - Settings - Gradleì—ì„œ Gradle JVMì„ [1]ì—ì„œ ì¶”ê°€í•œ í™˜ê²½ë³€ìˆ˜ë¡œ ì§€ì •
5. Intellij ìš°ì¸¡ Gradle í´ë¦­ í›„ ìƒˆë¡œê³ ì¹¨
6. Intellij - Run - GitherbsApplicationìœ¼ë¡œ ì‹¤í–‰
```

### Dockerfile (Back)

```docker
FROM openjdk:17-jdk
ADD ./build/libs/githerbs-0.0.1-SNAPSHOT.jar app.jar
ENTRYPOINT ["java", "-jar", "/app.jar"]
```

---

## Frontend Build

### .env

```
VITE_NAVER_CLIENT_KEY={Naver Map APIì˜ Client ID}
```

### IDE ë° í™˜ê²½ì„¤ì •

```
1. Node.js 20.11.1 ë‹¤ìš´ë¡œë“œ ë° í™˜ê²½ë³€ìˆ˜ ì„¤ì •
2. git clone í›„ frontend í´ë”ë¥¼ vscodeì—ì„œ Opení•˜ì—¬ ê°€ì ¸ì˜¤ê¸°
3. npm install
5. frontend í´ë” ìƒìœ„ ê²½ë¡œì— .env íŒŒì¼ ìœ„ì¹˜ì‹œí‚¤ê¸°
6. npm run build
```

### Dockerfile (Front)

```docker
# ë² ì´ìŠ¤ ì´ë¯¸ì§€ë¡œ Nginx ì‚¬ìš©
FROM nginx:stable-alpine

# Nginx ì„¤ì • íŒŒì¼ ë³µì‚¬
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Jenkinsì—ì„œ ë¹Œë“œëœ ê²°ê³¼ë¬¼ì„ Nginxì˜ ì •ì  íŒŒì¼ ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬
COPY ./dist /usr/share/nginx/html

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 80

# ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œ Nginx ì‹œì‘
CMD ["nginx", "-g", "daemon off;"]

```

### **.dockerignore** (Front)

```docker
node_modules
npm-debug.log
build
```

---

## Data Build

### ì¶”ì²œ ì•½ì´ˆ ì„œë²„ ë°°í¬

### IDE ë° í™˜ê²½ì„¤ì • (ìœˆë„ìš° í™˜ê²½)

```
# íŒŒì´ì¬ ì„¤ì¹˜
1. python (3.11) ì„¤ì¹˜ í›„ í™˜ê²½ë³€ìˆ˜ ì„¤ì •

# íŒŒì´ì¬ ê°€ìƒí™˜ê²½ ì„¤ì •
1. ê°€ìƒí™˜ê²½ ì„¤ì •í•  í´ë” ìƒì„±
2. í´ë”ì—ì„œ python -m venv ê°€ìƒí™˜ê²½ì´ë¦„ ì‹¤í–‰

# íŒŒì´ì¬ ê°€ìƒí™˜ê²½ ì§„ì…
1. ê°€ìƒí™˜ê²½ì•ˆì— ìˆëŠ” Scriptì—ì„œ activate ëª…ë ¹ì–´ ì‹¤í–‰
  (ê°€ìƒí™˜ê²½ì—ì„œ ë²—ì–´ë‚˜ê³  ì‹¶ì€ ê²½ìš°ëŠ” ê°™ì€ í´ë”ì—ì„œ deactivate ì‹¤í–‰)
2. ëª…ë ¹ í”„ë¡¬í¬íŠ¸ ì™¼ìª½ì— (ê°€ìƒí™˜ê²½ì´ë¦„) ì´ ë¶™ì–´ ìˆìœ¼ë©´ ì§„ì… ì™„ë£Œ

# ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
1. git clone ì„ í†µí•´ ë°›ì€ íŒŒì¼ ì¤‘ì—ì„œ requirements.txt ìˆëŠ” í´ë”ë¡œ ì´ë™
2. pip install -r requirements.txt ëª…ë ¹ì–´ë¥¼ í†µí•´ í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
  (pip freeze > requirements.txt ì€ ë‹¤ìš´ë°›ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª©ë¡ txtë¡œ ì €ì¥)
 
# fastapi ì‹¤í–‰
1. main.py ê°€ ìˆëŠ” í´ë”ë¡œ ì´ë™
2. uvicorn main:app --reload ë¡œ fastapi ì‹¤í–‰
```

### Dockerfile

```
FROM python:3.12.2

# JDK ì„¤ì¹˜
RUN apt-get update && \
    apt-get install -y default-jdk && \
    apt-get clean

# JAVA_HOME í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV JAVA_HOME /usr/lib/jvm/default-java
RUN export JAVA_HOME

WORKDIR /code

COPY ./requirements.txt /code/requirements.txt

RUN pip install --no-cache-dir --upgrade -r /code/requirements.txt

COPY ./main.py /code/
COPY ./recommender.py /code/
COPY herb_medicinal_effect.csv /code/

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "80"]
```

### Docker ì‹¤í–‰

```
# ì´ë¯¸ì§€ ë‹¤ì‹œ ë¹Œë“œí•˜ê¸°
docker build -t **ì´ë¯¸ì§€ ì´ë¦„** .

# ë¹Œë“œ í•œ ì´ë¯¸ì§€ ì‹¤í–‰
docker run --name **ì»¨í…Œì´ë„ˆì´ë¦„** -d -p **ec2ì—ì„œì ‘ì†í• í¬íŠ¸**:**Dockerfileì—ì íŒí¬íŠ¸** **ì´ë¯¸ì§€ì´ë¦„**

# ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸
docker logs **ì»¨í…Œì´ë„ˆì´ë¦„**
```

### ì´ë¯¸ì§€ ê²€ìƒ‰ ì„œë²„


## ë°°í¬ íŒŒì¼ í´ë” êµ¬ì¡°

```
ğŸ“¦githerbs
 â”£ ğŸ“‚domain
 â”ƒ â”£ ğŸ“‚auth
 â”ƒ â”ƒ â”£ ğŸ“‚controller
 â”ƒ â”ƒ â”£ ğŸ“‚dto
 â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚common
 â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚request
 â”ƒ â”ƒ â”ƒ â”— ğŸ“‚response
 â”ƒ â”ƒ â”£ ğŸ“‚entity
 â”ƒ â”ƒ â”£ ğŸ“‚repository
 â”ƒ â”ƒ â”— ğŸ“‚service
 â”ƒ â”£ ğŸ“‚board
 â”ƒ â”ƒ â”£ ğŸ“‚controller
 â”ƒ â”ƒ â”£ ğŸ“‚dto
 â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚request
 â”ƒ â”ƒ â”ƒ â”— ğŸ“‚response
 â”ƒ â”ƒ â”£ ğŸ“‚entity
 â”ƒ â”ƒ â”£ ğŸ“‚repository
 â”ƒ â”ƒ â”— ğŸ“‚service
 â”ƒ â”£ ğŸ“‚event
 â”ƒ â”ƒ â”£ ğŸ“‚controller
 â”ƒ â”ƒ â”£ ğŸ“‚dto
 â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚request
 â”ƒ â”ƒ â”ƒ â”— ğŸ“‚response
 â”ƒ â”ƒ â”£ ğŸ“‚entity
 â”ƒ â”ƒ â”£ ğŸ“‚repository
 â”ƒ â”ƒ â”— ğŸ“‚service
 â”ƒ â”£ ğŸ“‚herb
 â”ƒ â”ƒ â”£ ğŸ“‚controller
 â”ƒ â”ƒ â”£ ğŸ“‚dto
 â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚request
 â”ƒ â”ƒ â”ƒ â”— ğŸ“‚response
 â”ƒ â”ƒ â”£ ğŸ“‚entity
 â”ƒ â”ƒ â”£ ğŸ“‚repository
 â”ƒ â”ƒ â”— ğŸ“‚service
 â”ƒ â”£ ğŸ“‚manual
 â”ƒ â”ƒ â”£ ğŸ“‚controller
 â”ƒ â”ƒ â”£ ğŸ“‚dto
 â”ƒ â”ƒ â”ƒ â”— ğŸ“‚response
 â”ƒ â”ƒ â”£ ğŸ“‚entity
 â”ƒ â”ƒ â”£ ğŸ“‚repository
 â”ƒ â”ƒ â”— ğŸ“‚service
 â”ƒ â”£ ğŸ“‚member
 â”ƒ â”ƒ â”£ ğŸ“‚controller
 â”ƒ â”ƒ â”£ ğŸ“‚dto
 â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚common
 â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚request
 â”ƒ â”ƒ â”ƒ â”— ğŸ“‚response
 â”ƒ â”ƒ â”£ ğŸ“‚entity
 â”ƒ â”ƒ â”£ ğŸ“‚repository
 â”ƒ â”ƒ â”— ğŸ“‚service
 â”ƒ â”— ğŸ“‚search
 â”ƒ â”ƒ â”£ ğŸ“‚controller
 â”ƒ â”ƒ â”£ ğŸ“‚dto
 â”ƒ â”ƒ â”ƒ â”— ğŸ“‚response
 â”ƒ â”ƒ â”£ ğŸ“‚entity
 â”ƒ â”ƒ â”£ ğŸ“‚repository
 â”ƒ â”ƒ â”— ğŸ“‚service
 â”£ ğŸ“‚global
 â”ƒ â”£ ğŸ“‚common
 â”ƒ â”ƒ â”£ ğŸ“‚code
 â”ƒ â”ƒ â”£ ğŸ“‚exception
 â”ƒ â”ƒ â”— ğŸ“‚response
 â”ƒ â”£ ğŸ“‚config
 â”ƒ â”— ğŸ“‚handler
 â”— ğŸ“œGitherbsApplication.java

```

```
ğŸ“¦frontend
 â”£ ğŸ“‚public
 â”ƒ â”£ ğŸ“‚grass
 â”ƒ â”£ ğŸ“‚herbs
 â”ƒ â”£ ğŸ“‚pediaimg
 â”ƒ â”£ ğŸ“‚profileimg
 â”£ ğŸ“‚src
 â”ƒ â”£ ğŸ“‚apis
 â”ƒ â”£ ğŸ“‚assets
 â”ƒ â”ƒ â”£ ğŸ“‚fonts
 â”ƒ â”£ ğŸ“‚components
 â”ƒ â”ƒ â”£ ğŸ“‚board
 â”ƒ â”ƒ â”£ ğŸ“‚escape
 â”ƒ â”ƒ â”£ ğŸ“‚herbdetail
 â”ƒ â”ƒ â”£ ğŸ“‚main
 â”ƒ â”ƒ â”£ ğŸ“‚mypage
 â”ƒ â”ƒ â”£ ğŸ“‚pedia
 â”ƒ â”ƒ â”£ ğŸ“‚picture
 â”ƒ â”ƒ â”£ ğŸ“‚search
 â”ƒ â”£ ğŸ“‚pages
 â”ƒ â”£ ğŸ“‚store
 â”ƒ â”£ ğŸ“‚utils

```

```
ğŸ“¦data
 â”£ ğŸ“‚image
 â”ƒ â”£ ğŸ“‚model
 â”ƒ â”£ ğŸ“‚notebook
 â”ƒ â”ƒ â”£ ğŸ“‚output
 â”£ ğŸ“‚search
```

# âš™ï¸ Server Settings

## Putty

- MobaXtermì„ í†µí•´ EC2 ì„œë²„ì— ì ‘ì†

```
1. ì¢Œì¸¡ ìƒë‹¨ì˜ Session - SSH í´ë¦­
2. í•„ìš” ì •ë³´ ì…ë ¥
	- 1. Remote Host: EC2 Domain ì…ë ¥
	- 2. Specify username: ì²´í¬ í›„ ubuntu ì…ë ¥
3. Advanced SSH settings íƒ­ í´ë¦­
4. í•„ìš” ì •ë³´ ì…ë ¥
	- 1. Use private key ì²´í¬ í›„ .pem íŒŒì¼ ì²¨ë¶€
5. Bookmark settings - Session nameì—ì„œ ì›í•˜ëŠ” ì„œë²„ ì´ë¦„ ì…ë ¥
```

## Server Default Setting

- í•œêµ­ í‘œì¤€ì‹œë¡œ ë³€ê²½

```bash
sudo timedatectl set-timezone Asia/Seoul
```

- íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸ ë° íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸

```bash
sudo apt-get -y update && sudo apt-get -y upgrade
```

## Docker Setting

- Docker ì„¤ì¹˜ ì „ í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
sudo apt-get -y install apt-transport-https ca-certificates curl gnupg-agent software-properties-common
```

- amd / arm í™•ì¸

```bash
dpkg -s libc6 | grep Arch
```

- ìœ„ì— í•´ë‹¹í•˜ëŠ” ê³„ì—´ë¡œ Docker ë ˆí¬ì§€í† ë¦¬ ë“±ë¡
ì„ì˜ë¡œ amd / arm â‡’ verë¡œ ì‘ì„±

```bash
sudo add-apt-repository "deb [arch=ver64] https://download.docker.com/linux/ubuntu$(lsb_release -cs) stable"
```

- íŒ¨í‚¤ì§€ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 

```bash
sudo apt-get -y update
```

- Docker íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
sudo apt-get -y install docker-ce docker-ce-cli containerd.io
```

- Docker ì„œë¹„ìŠ¤ ì¬ì‹œì‘

```bash
sudo service docker restart
exit
```

## SSL Setting

- nginxë¥¼ ì„¤ì¹˜

```bash
sudo apt-get -y install nginx
```

- CertBot ë‹¤ìš´ë¡œë“œ

```bash
sudo snap install --classic certbot
```

- SSL ì¸ì¦ì„œ ë°œê¸‰

```bash
sudo nginx --nginx -d my.domain.com
ì´í›„ì— ì´ë©”ì¼ ì£¼ì†Œ ì…ë ¥
```

## Mysql & Redis

```yaml
version: '3.1'
services:
  mysql:
    image: mysql:8.0
    container_name: mysql
    ports:
      - 3306:3306 # HOST:CONTAINER
    environment:
      MYSQL_ROOT_PASSWORD: {mysql-password}
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    volumes:
      - /home/ubuntu/docker-compose/mysql/mysql:/var/lib/mysql
    restart: always
  
  redis:
    image: redis
    container_name: redis
    ports:
      - 6379:6379
    volumes:
      - /home/ubuntu/docker-compose/redis/data:/data
      - /home/ubuntu/docker-compose/redis/redis:/usr/local/etc/redis
    command: redis-server /usr/local/etc/redis/redis.conf
```

- [https://raw.githubusercontent.com/redis/redis/7.2/redis.conf](https://raw.githubusercontent.com/redis/redis/7.2/redis.conf) ì ‘ì† í›„ íŒŒì¼ ë‹¤ìš´ë¡œë“œ, ìˆ˜ì •

```
# redis.conf
bind 127.0.0.1 -::1 -> bind * -::*
requirepass ->  {ë ˆë””ìŠ¤ ë¹„ë°€ë²ˆí˜¸}
```

## Jenkins

- docker-compose.yml ì‘ì„±

```
version: '3'

services:
  jenkins:
    image: jenkins/jenkins:latest-jdk17
    privileged: true
    user: root
    ports:
      - í¬íŠ¸ë²ˆí˜¸!!!:8080
    container_name: ì»¨í…Œì´ë„ˆì´ë¦„!!!!
    volumes:
      - ./jenkins_home:/var/jenkins_home
    restart: unless-stopped
    command: bash -c "apt-get update && apt-get install -y docker.io && jenkins.sh"
```

- docker-compose up -d ì‹¤í–‰ í›„

```
docker logs ì»¨í…Œì´ë„ˆì´ë¦„!!! ì‹¤í–‰ ê·¸ ì•ˆì—ì„œ í† í°ì´ ë“±ì¥
ì§€ì •ëœ í¬íŠ¸ë¡œ ì ‘ì† í›„ í† í°ì„ ì…ë ¥ í•˜ë©´ ê¸°ë³¸ ì„¤ì • í˜ì´ì§€ê°€ ë“±ì¥
idì™€ password ì„¤ì • í›„ ê¸°ë³¸ í”ŒëŸ¬ê·¸ì¸ ë‹¤ìš´ë¡œë“œ ì§„í–‰
```

- ì¶”ê°€ í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜

```
SSH Agent

Docker
Docker Commons
Docker Pipeline
Docker API

Generic Webhook Trigger

GitLab
GitLab API,
GitLab Authentication

NodeJS

Mattermost Notification
```

- ìƒˆë¡œìš´ itemìœ¼ë¡œ back front ì•„ì´í…œ ìƒì„±

```
1. ìƒì„± í›„ Build Triggersì•ˆì— Build when a change is pushed to GitLab. GitLab webhook URL: ì²´í¬ í›„ URL ë³µì‚¬
2. push Eventsì™€ Opened Merge Request Events ì²´í¬
3. ê³ ê¸‰ì„ ì„ íƒ í›„ Secret token Generate ì‹¤í–‰ í›„ ë³µì‚¬
4. ê¹ƒë© ì ‘ì† í›„ í”„ë¡œì íŠ¸ ì„ íƒ â†’ Settings â†’ Webhooks ì ‘ì†
5. add new webhook ì„ íƒ í›„ jeninsì—ì„œ ë³µì‚¬í•œ URL ì…ë ¥
6. Secret tokenì— ë³µì‚¬í–ˆë˜ Secret token ì…ë ¥
7. íŠ¸ë¦¬ê±°ì— push events ì„ íƒ í›„ ì €ì¥
```

## Docker Hub Setting

- Docker Hub Token ë°œê¸‰

```
1. ìš°ì¸¡ ìƒë‹¨ì˜ Sign in ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¡œê·¸ì¸
2. ìš°ì¸¡ ìƒë‹¨ì˜ ê³„ì •ëª…ì„ í´ë¦­í•˜ì—¬ Account Settings í´ë¦­
3. New Access Token - Read,Write,Delete ê¶Œí•œì„ ê°€ì§„ Token ë°œê¸‰
4. Token ê°’ ì €ì¥
```

- Docker Hub Repository ìƒì„±

```
1. ìƒë‹¨ì˜ Repositories - Create repository í´ë¦­
2. Visibility ì§€ì • í›„ Create í´ë¦­
```

## Jenkins Pipeline Setting

- í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜
    - Jenkins ê´€ë¦¬ - Plugins - Available Plugins - ì„ íƒ í›„ Install without restart í´ë¦­

```
SSH Agent

Docker
Docker Commons
Docker Pipeline
Docker API

Generic Webhook Trigger

GitLab
GitLab API,
GitLab Authentication

NodeJS

Mattermost Notification
```

- Docker Hub Credential ë“±ë¡
    - Jenkins ê´€ë¦¬ - Credentials - global - Add Credentials - Create

```
Kind: Username with password
Username: Docker Hubì—ì„œ ì‚¬ìš©í•˜ëŠ” ID
Password: Docker Hubì—ì„œ ì‚¬ìš©í•˜ëŠ” Token ê°’
ID: Credentialì— ëŒ€í•œ ë³„ì¹­
```

- GitLab Credential ë“±ë¡
    - Jenkins ê´€ë¦¬ - Credentials - global - Add Credentials - Create

```
Kind: Username with password
Username: GitLab ê³„ì • ì•„ì´ë”” ì…ë ¥
Password: GitLab ê³„ì • ë¹„ë°€ë²ˆí˜¸
ID: Credentialì— ëŒ€í•œ ë³„ì¹­
```

- Ubuntu Credential ë“±ë¡
    - Jenkins ê´€ë¦¬ - Plugins - Available Plugins - SSH Agent
    - Jenkins ê´€ë¦¬ - Credentials - global - Add Credentials - Create

```
Kind: Username with private key
ID: Credentialì— ëŒ€í•œ ë³„ì¹­
Username: SSH ì›ê²© ì„œë²„ í˜¸ìŠ¤íŠ¸ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê³„ì •ëª…(ubuntu)
====> Enter directly - Add í´ë¦­
.pem í‚¤ì˜ ë‚´ìš©ì„ ë©”ëª¨ì¥ì„ ì½ì–´ ë³µì‚¬ í›„ Keyì— ë¶™ì—¬ë„£ì€ í›„ Create
```

- logback ë“±ë¡

```
Kind: Secret file
ID: Credentialì— ëŒ€í•œ ë³„ì¹­
file : logback-spring.xml ì„ íƒ í›„ create
```

```
<?xml version="1.0" encoding="utf-8" ?>
<configuration>
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
    <include resource="org/springframework/boot/logging/logback/console-appender.xml" />
    <springProperty scope="context" name="application_name" source="spring.application.name"/>

    <appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
        <destination>{ë¡œê·¸ ìŠ¤íƒœì‹œ ì£¼ì†Œ}:{ë¡œê·¸ ìŠ¤íƒœì‹œ í¬íŠ¸}</destination>
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <customFields>{"app_name":"${application_name}"}</customFields>
            <includeMdcKeyName>METHOD</includeMdcKeyName>
            <includeMdcKeyName>URI</includeMdcKeyName>
            <includeMdcKeyName>PARAMS</includeMdcKeyName>
            <fieldNames>
                <timestamp>timestamp</timestamp>
                <message>message</message>
                <thread>thread</thread>
                <level>level</level>
                <stackTrace>stack_trace</stackTrace>
            </fieldNames>
            <stackTraceConfiguration>
                <throwableConverter class="net.logstash.logback.stacktrace.ShortenedThrowableConverter">
                    <maxDepthPerThrowable>30</maxDepthPerThrowable>
                    <maxLength>2048</maxLength>
                    <shortenedClassNameLength>20</shortenedClassNameLength>
                    <exclude>^sun\.reflect\..*\.invoke</exclude>
                    <exclude>^net\.sf\.cglib\.proxy\.MethodProxy\.invoke</exclude>
                    <rootCauseFirst>true</rootCauseFirst>
                </throwableConverter>
            </stackTraceConfiguration>
        </encoder>
    </appender>

    <root level="INFO">
        <appender-ref ref="LOGSTASH"/>
        <appender-ref ref="CONSOLE"/>
    </root>
</configuration>
```

- Gradle ì¶”ê°€
    - Jenkins ê´€ë¦¬ - Tools

```
name: gradle
Install automatically ì²´í¬
í”„ë¡œì íŠ¸ ë²„ì „ì— ë§ëŠ” Gradle ì„ íƒ í›„ Save
```


# ğŸ’½ Data Import

```
1. Mysql Workbench ì ‘ì†
2. ë°ì´í„°ë² ì´ìŠ¤ì™€ ì—°ê²°
3. ìƒë‹¨ì˜ server - Data Import ì„ íƒ
4. Import from Self-Contained File ì„ íƒ í›„ sql íŒŒì¼ ì„ íƒ
5. Default Target Schemaì—ì„œ ì‚¬ìš©í•  Schema ì„ íƒ
6. Start Import ì„ íƒ
```

# ğŸ¬ Deployment Command

## Pipeline (Back)

```bash
pipeline {
    agent any
    
    environment {
        imagename = "dockerhub repo ì´ë¦„" // ì‚¬ìš©ìëª…/repoëª…
        registryCredential = 'dockerhub' // docker hub credential ID
        dockerImage = ''
        releaseServerAccount = 'ubuntu'
        releaseServerUri = 'i11a409.p.ssafy.io'
        // releasePort = '8080' // Spring bootëŠ” 8080 í¬íŠ¸
    }
    
    tools {
        gradle 'gradle'
    }
    
    stages {
        stage('clone') {
            steps {
                git branch: 'ë¸Œëœì¹˜ëª…', credentialsId: 'credentialëª…', url: 'https~.git í˜•ì‹ì˜ Git ì£¼ì†Œì†Œ'
            }
        }
        stage('back_build') {
            steps {
                dir('kiot') { // í•˜ìœ„ì˜ 'kiot' ë””ë ‰í† ë¦¬ë¡œ ì´ë™
                    sh "chmod +x gradlew"
                    sh "./gradlew clean bootJar"
                }
            }
        }
        stage('docker-build'){
            steps {
                dir('kiot'){
                    script {
                        docker.withRegistry('', registryCredential) {
                        sh "docker buildx create --use --name mybuilder"
                        sh "docker buildx build --platform linux/amd64,linux/arm64 -t $imagename:$BUILD_NUMBER --push ."
                        sh "docker buildx build --platform linux/amd64,linux/arm64 -t $imagename:latest --push ."
                    }
                    }
                }
            }
        }
        
        stage('Before Service Stop') {
            steps {
                sshagent(credentials: ['CommonEC2']) {
                    sh '''
                    if test "`ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker ps -aq --filter ancestor=$imagename:latest"`"; then
                    ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker stop $(docker ps -aq --filter ancestor=$imagename:latest)"
                    ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker rm -f $(docker ps -aq --filter ancestor=$imagename:latest)"
                    ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker rmi $imagename:latest"
                    fi
                    '''
                }
            }
        }
        stage('SSH-Server-EC2'){
            steps {
                echo 'SSH'
                
                sshagent(credentials: ['CommonEC2']) {
                    
                    sh 'ssh -o StrictHostKeyChecking=no ubuntu@i11a409.p.ssafy.io "docker pull ennw00/kiotserver:latest"'
                    sh 'ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "sudo docker run -d -i -v ~/keystore_dev.p12:/app/keystore_dev.p12 --env-file ~/.env --name kiotserver -p 8443:8443 $imagename:latest"'
                } 
            }
        }
    }
}
```

## Pipeline (Flask)

```bash
pipeline {
    agent any
    
    environment {
        imagename = "dockerhub repo ì´ë¦„" // ex: ì‚¬ìš©ìëª…/repoëª…
        registryCredential = 'dockerhub'
        dockerImage = ''
        releaseServerAccount = 'ubuntu'
        releaseServerUri = 'i11a409.p.ssafy.io'
        // releasePort = '5000' // Flaskì˜ í¬íŠ¸ëŠ” 5000
    }
    
    stages {
        stage('clone') {
            steps {
                git branch: 'ë¸Œëœì¹˜ëª…', credentialsId: 'gitlabClaire', url: 'https://lab.ssafy.com/s11-webmobile2-sub2/S11P12A409.git'
            }
        }
        
        stage('docker-build'){
            steps {
                dir('Flask'){ // flask ë¸Œëœì¹˜ > Flask í´ë”ë¡œ ì§„ì…
                    script {
                        docker.withRegistry('', registryCredential) {
                        sh "docker buildx create --use --name mybuilder"
                        sh "docker buildx build --platform linux/amd64,linux/arm64 -t $imagename:$BUILD_NUMBER --push ."
                        sh "docker buildx build --platform linux/amd64,linux/arm64 -t $imagename:latest --push ."
                    }
                    }
                }
            }
        }
        stage('Before Service Stop') {
            steps {
                sshagent(credentials: ['CommonEC2']) {
                    sh '''
                    if test "`ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker ps -aq --filter ancestor=$imagename:latest"`"; then
                    ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker stop $(docker ps -aq --filter ancestor=$imagename:latest)"
                    ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker rm -f $(docker ps -aq --filter ancestor=$imagename:latest)"
                    ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "docker rmi $imagename:latest"
                    fi
                    '''
                }
            }
        }
        stage('SSH-Server-EC2'){
            steps {
                echo 'SSH'
                
                sshagent(credentials: ['CommonEC2']) {
                    
                    sh 'ssh -o StrictHostKeyChecking=no ubuntu@i11a409.p.ssafy.io "docker pull ennw00/kiotflask:latest"'
                    sh 'ssh -o StrictHostKeyChecking=no $releaseServerAccount@$releaseServerUri "sudo docker run -d -i -e TZ=Asia/Seoul -e PYANNOTE_TOKEN=í† í°ê°’ -e SECRET_KEY=ì‹œí¬ë¦¿í‚¤ ê°’ --name kiotflask -p 5000:5000 $imagename:latest"'
                    
                } 
            }
        }
    }
}
```
